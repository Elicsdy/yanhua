<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>烟花效果 - 手机版</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        body { 
            background: #000; 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw;
            font-family: 'Arial', sans-serif;
            touch-action: manipulation;
        }
        
        canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            display: block;
        }
        
        .text-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            text-align: center;
            width: 90%;
            max-width: 500px;
            pointer-events: none;
        }
        
        .text-box {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            font-weight: bold;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            animation: pulse 3s infinite;
            word-break: break-word;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.2); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.5); }
            100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.2); }
        }
        
        .mobile-tip {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            z-index: 10;
            padding: 0 20px;
        }
        
        .performance-warning {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            z-index: 10;
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="fireworksCanvas"></canvas>
    <div class="text-display">
        <div class="text-box" id="displayText">烟花效果</div>
    </div>
    <div class="mobile-tip">点击屏幕任意位置发射烟花</div>
    <div class="performance-warning" id="performanceWarning">性能模式已启用</div>

    <script>
        // 性能优化配置
        const config = {
            maxParticles: 100,           // 手机端减少粒子数量
            autoFireInterval: 500,       // 降低自动发射频率
            particleSize: 3,             // 减小粒子尺寸
            explosionSize: 2,            // 减小爆炸范围
            enablePerformanceMode: false // 性能模式开关
        };

        const canvas = document.getElementById('fireworksCanvas');
        const ctx = canvas.getContext('2d');
        const displayText = document.getElementById('displayText');
        const performanceWarning = document.getElementById('performanceWarning');
        
        // 检测移动设备
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // 性能检测
        let frameCount = 0;
        let lastTime = performance.now();
        let fps = 60;
        
        // 设置 Canvas 尺寸（处理高DPI屏幕）
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            ctx.scale(dpr, dpr);
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', () => {
            setTimeout(resizeCanvas, 100);
        });
        
        // 从 URL 获取参数
        function getURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const word = urlParams.get('word');
            if (word) {
                displayText.textContent = decodeURIComponent(word);
            }
        }
        
        // 烟花粒子类（优化版）
        class Particle {
            constructor(x, y, color, velocity, size, decay) {
                this.x = x; 
                this.y = y; 
                this.color = color;
                this.velocity = velocity; 
                this.size = size; 
                this.decay = decay; 
                this.alpha = 1; 
                this.gravity = 0.01;
                this.life = 1.0;
            }
            
            update() {
                this.velocity.x *= 0.99; 
                this.velocity.y *= 0.99;
                this.velocity.y += this.gravity;
                this.x += this.velocity.x; 
                this.y += this.velocity.y;
                this.life -= this.decay;
                this.alpha = this.life;
                
                return this.life > 0;
            }
            
            draw() {
                if (this.alpha <= 0) return;
                
                ctx.save(); 
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color; 
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); 
                ctx.fill();
                ctx.restore();
            }
        }
        
        // 烟花类（优化版）
        class Firework {
            constructor(x, y, targetX, targetY) {
                this.x = x; 
                this.y = y; 
                this.targetX = targetX; 
                this.targetY = targetY;
                this.size = config.particleSize; 
                this.particleCount = isMobile ? Math.min(config.maxParticles, 80) : 120;
                this.explosionSize = config.explosionSize;
                
                this.distance = Math.sqrt(Math.pow(targetX - x, 2) + Math.pow(targetY - y, 2));
                this.speed = 3 + Math.random() * 4; // 手机端降低速度
                this.angle = Math.atan2(targetY - y, targetX - x);
                this.velocity = { 
                    x: Math.cos(this.angle) * this.speed, 
                    y: Math.sin(this.angle) * this.speed 
                };
                
                this.trail = []; 
                this.exploded = false; 
                this.particles = [];
                this.color = this.getRandomColor();
            }
            
            getRandomColor() {
                const colors = [
                    '#ff0000', '#00ff00', '#0000ff', '#ffff00', 
                    '#ff00ff', '#00ffff', '#ff8a00', '#da1b60',
                    '#8a2be2', '#7fff00'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            update() {
                if (!this.exploded) {
                    this.x += this.velocity.x; 
                    this.y += this.velocity.y;
                    
                    // 优化轨迹点数量
                    this.trail.push({x: this.x, y: this.y});
                    if (this.trail.length > 3) this.trail.shift();
                    
                    const distanceToTarget = Math.sqrt(
                        Math.pow(this.targetX - this.x, 2) + Math.pow(this.targetY - this.y, 2)
                    );
                    
                    if (distanceToTarget < 10) {
                        this.explode();
                    }
                } else {
                    this.particles = this.particles.filter(particle => particle.update());
                }
            }
            
            explode() {
                this.exploded = true;
                const particleCount = config.enablePerformanceMode ? 
                    Math.min(this.particleCount, 50) : this.particleCount;
                
                for (let i = 0; i < particleCount; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * this.explosionSize;
                    
                    const velocity = { 
                        x: Math.cos(angle) * speed, 
                        y: Math.sin(angle) * speed 
                    };
                    
                    const size = Math.random() * this.size + 1;
                    const decay = 0.008 + Math.random() * 0.01;
                    
                    this.particles.push(
                        new Particle(this.x, this.y, this.color, velocity, size, decay)
                    );
                }
            }
            
            draw() {
                if (!this.exploded) {
                    // 绘制轨迹
                    for (let i = 0; i < this.trail.length; i++) {
                        const point = this.trail[i]; 
                        const alpha = i / this.trail.length;
                        
                        ctx.save(); 
                        ctx.globalAlpha = alpha * 0.7; 
                        ctx.fillStyle = this.color;
                        ctx.beginPath(); 
                        ctx.arc(point.x, point.y, this.size * alpha, 0, Math.PI * 2); 
                        ctx.fill();
                        ctx.restore();
                    }
                    
                    // 绘制烟花主体
                    ctx.fillStyle = this.color; 
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); 
                    ctx.fill();
                } else {
                    // 绘制所有粒子
                    this.particles.forEach(particle => particle.draw());
                }
            }
        }
        
        const fireworks = [];
        let autoFireInterval;
        let touchStartTime = 0;
        
        // 创建烟花（移动端优化）
        function createFirework(startX, startY, targetX, targetY) {
            // 限制同时存在的烟花数量
            if (fireworks.length > (isMobile ? 5 : 10)) {
                fireworks.shift();
            }
            fireworks.push(new Firework(startX, startY, targetX, targetY));
        }
        
        // 自动发射（移动端减少频率）
        function startAutoFire() {
            if (autoFireInterval) clearInterval(autoFireInterval);
            
            autoFireInterval = setInterval(() => {
                if (fireworks.length < (isMobile ? 3 : 8)) {
                    const startX = Math.random() * canvas.width;
                    const startY = canvas.height;
                    const targetX = Math.random() * canvas.width;
                    const targetY = Math.random() * canvas.height * 0.6;
                    
                    createFirework(startX, startY, targetX, targetY);
                }
            }, isMobile ? 800 : 400);
        }
        
        // FPS 检测和性能调整
        function checkPerformance() {
            frameCount++;
            const currentTime = performance.now();
            
            if (currentTime - lastTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = currentTime;
                
                // 如果FPS过低，启用性能模式
                if (fps < 30 && !config.enablePerformanceMode) {
                    config.enablePerformanceMode = true;
                    config.maxParticles = 50;
                    performanceWarning.style.display = 'block';
                    setTimeout(() => {
                        performanceWarning.style.display = 'none';
                    }, 3000);
                }
            }
        }
        
        // 动画循环
        function animate() {
            checkPerformance();
            
            // 使用更高效的清屏方式
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 更新和绘制所有烟花
            fireworks.forEach(firework => { 
                firework.update(); 
                firework.draw(); 
            });
            
            // 移除已消失的烟花
            for (let i = fireworks.length - 1; i >= 0; i--) {
                if (fireworks[i].exploded && fireworks[i].particles.length === 0) {
                    fireworks.splice(i, 1);
                }
            }
            
            requestAnimationFrame(animate);
        }
        
        // 触摸事件处理
        function setupTouchEvents() {
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                touchStartTime = Date.now();
                
                const touch = e.touches[0];
                const startX = canvas.width / 2;
                const startY = canvas.height;
                const targetX = touch.clientX;
                const targetY = touch.clientY;
                
                createFirework(startX, startY, targetX, targetY);
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                
                // 限制触摸移动时的发射频率
                if (Date.now() - touchStartTime > 200) {
                    const touch = e.touches[0];
                    const startX = canvas.width / 2;
                    const startY = canvas.height;
                    const targetX = touch.clientX;
                    const targetY = touch.clientY;
                    
                    createFirework(startX, startY, targetX, targetY);
                    touchStartTime = Date.now();
                }
            });
            
            // 点击事件（兼容非触摸设备）
            canvas.addEventListener('click', (e) => {
                const startX = canvas.width / 2;
                const startY = canvas.height;
                const targetX = e.clientX;
                const targetY = e.clientY;
                
                createFirework(startX, startY, targetX, targetY);
            });
        }
        
        // 初始化
        getURLParams();
        setupTouchEvents();
        animate();
        startAutoFire();
        
        // 页面可见性处理（节省电量）
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (autoFireInterval) clearInterval(autoFireInterval);
            } else {
                startAutoFire();
            }
        });
        
        console.log('移动设备:', isMobile);
        console.log('设备像素比:', window.devicePixelRatio);
    </script>
</body>
</html>